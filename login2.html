<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">

    <!-- font awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta2/css/all.min.css" integrity="sha512-YWzhKL2whUzgiheMoBFwW8CKV4qpHQAEuvilg9FAn5VJUDwKZZxkJNuGM4XkWuk94WCrrwslk8yWNGmY1EduTA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- normalize css -->
    <link rel = "stylesheet" href = "css/normalize.css">
    <!-- custom css -->
    <link rel = "stylesheet" href = "css/main.css">
    <link rel="icon" href="img/image-removebg-preview.png" type="image/png">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Raleway|Ubuntu" rel="stylesheet">

    <!-- Estilos -->
    <link rel="stylesheet" href="css/login.css">

    <title>Formulario Login y Registro de Usuarios</title>
</head>
<body>
    
    
    <!-- Modal de Notificaci√≥n -->
  <div id="modal-notificacion" class="modal-notificacion">
    <div class="modal-contenido">
      <span class="modal-cerrar" id="cerrar-modal">&times;</span>
      <div class="modal-icono">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <h2 id="modal-titulo">¬°Error!</h2>
      <p id="modal-mensaje">Usuario o contrase√±a incorrectos.</p>
    </div>
  </div>

<!-- Formularios -->
<div class="contenedor-formularios">
    <!-- Links de los formularios -->
    <ul class="contenedor-tabs">
        <li class="tab tab-segunda active"><a href="#iniciar-sesion">Iniciar Sesi√≥n</a></li>
        <li class="tab tab-primera"><a href="#registrarse">Registrarse</a></li>
    </ul>

    <!-- Contenido de los Formularios -->
    <div class="contenido-tab">
        <!-- Iniciar Sesion -->
        <div id="iniciar-sesion">
            <h1>Iniciar Sesi√≥n</h1>
            <form id="form-iniciar-sesion" action="#" method="post">
                <div class="contenedor-input">
                    <label>
                        Usuario <span class="req">*</span>
                    </label>
                    <input type="text" name="usuario" required>
                </div>

                <div class="contenedor-input">
                    <label>
                        Contrase√±a <span class="req">*</span>
                    </label>
                    <input type="password" name="password" required>
                </div>
                <p class="forgot"><a href="restablecer.html">Se te olvid√≥ la contrase√±a?</a></p>
                <input type="submit" class="button button-block" value="Iniciar Sesi√≥n">
                <button type="button" id="google-login-btn" class="google-btn">
            <svg class="google-icon" viewBox="0 0 24 24" width="20" height="20">
              <path
                fill="#4285F4"
                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
              />
              <path
                fill="#34A853"
                d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
              />
              <path
                fill="#FBBC05"
                d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
              />
              <path
                fill="#EA4335"
                d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
              />
            </svg>
            Continuar con Google
          </button>
            </form>
        </div>

        <!-- Registrarse -->
        <div id="registrarse">
            <h1>Registrarse</h1>
            <form id="form-registrarse" action="#" method="post">
                <div class="fila-arriba">
                    <div class="contenedor-input">
                        <label>
                            Nombre <span class="req">*</span>
                        </label>
                        <input type="text" name="nombre" required>
                    </div>
                </div>
                <div class="contenedor-input">
                    <label>
                        Usuario <span class="req">*</span>
                    </label>
                    <input type="text" name="usuario" required>
                </div>
                <div class="contenedor-input">
                    <label>
                        Email <span class="req">*</span>
                    </label>
                    <input type="email" name="email" required>
                </div>
                <div class="contenedor-input">
                    <label>
                        Contrase√±a <span class="req">*</span>
                    </label>
                    <input type="password" name="password" required>
                </div>
                <div class="contenedor-input">
                    <label>
                        Repetir Contrase√±a <span class="req">*</span>
                    </label>
                    <input type="password" name="repeat_password" required>
                </div>
                <input type="submit" class="button button-block" value="Registrarse">
            </form>
        </div>
    </div>
</div>



    



   <script src="js/login2.js"></script>
   <script src="js/script.js"></script>
   <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import {
        getAuth,
        GoogleAuthProvider,
        signInWithPopup,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCKjCFCiAR3zmNfxlJaTvuK6c9x4aiVwWA",
        authDomain: "auth-db694.firebaseapp.com",
        projectId: "auth-db694",
        storageBucket: "auth-db694.firebasestorage.app",
        messagingSenderId: "683638951819",
        appId: "1:683638951819:web:9f1ce6c932527ac2c4298e",
        measurementId: "G-47ZN59HEWV"
      };
      console.log("Inicializando Firebase para Google Login...");

      try {
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();

        googleProvider.addScope("email");
        googleProvider.addScope("profile");

        googleProvider.setCustomParameters({
          prompt: "select_account",
        });

        console.log("Firebase inicializado correctamente");

        // Hacer disponibles globalmente
        window.firebaseAuth = auth;
        window.googleProvider = googleProvider;
        window.signInWithPopup = signInWithPopup;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;

        console.log("Google Login disponible");
      } catch (error) {
        console.error("‚ùå Error al inicializar Firebase:", error);
        alert("Error de configuraci√≥n Firebase: " + error.message);
      }
    </script>

    <script>
      console.log("Sistema de Login con Google iniciado");

      // Esperar a que Firebase est√© listo
      const waitForFirebase = () => {
        return new Promise((resolve) => {
          const checkFirebase = () => {
            if (
              window.firebaseAuth &&
              window.googleProvider &&
              window.signInWithPopup
            ) {
              console.log("Firebase listo para usar");
              resolve();
            } else {
              console.log("‚è≥ Esperando Firebase...");
              setTimeout(checkFirebase, 100);
            }
          };
          checkFirebase();
        });
      };

      document.addEventListener("DOMContentLoaded", async function () {
        console.log(" DOM cargado");

        // Esperar Firebase
        await waitForFirebase();

        // **CONFIGURACI√ìN**
        const API_URL = "http://localhost:3000/api";

        // **ELEMENTOS DEL DOM**
        const elements = {
          container: document.querySelector(".container"),
          loginForm: document.getElementById("loginForm"),
          registerForm: document.getElementById("registerForm"),
          googleLoginBtn: document.getElementById("google-login-btn"),
          googleRegisterBtn: document.getElementById("google-register-btn"),
          registerBtn: document.querySelector(".register-btn"),
          loginBtn: document.querySelector(".login-btn"),
          goToRegister: document.getElementById("go-to-register"),
          goToLogin: document.getElementById("go-to-login"),
        };

        console.log("Elementos encontrados:", {
          container: !!elements.container,
          loginForm: !!elements.loginForm,
          registerForm: !!elements.registerForm,
          googleLoginBtn: !!elements.googleLoginBtn,
          googleRegisterBtn: !!elements.googleRegisterBtn,
        });

        // **NAVEGACI√ìN ENTRE FORMULARIOS**
        const showRegister = () => {
          console.log("üîÑ Mostrando formulario de registro");
          elements.container.classList.add("active");
        };

        const showLogin = () => {
          console.log("üîÑ Mostrando formulario de login");
          elements.container.classList.remove("active");
        };

        // Event listeners para navegaci√≥n
        elements.registerBtn?.addEventListener("click", showRegister);
        elements.goToRegister?.addEventListener("click", (e) => {
          e.preventDefault();
          showRegister();
        });

        elements.loginBtn?.addEventListener("click", showLogin);
        elements.goToLogin?.addEventListener("click", (e) => {
          e.preventDefault();
          showLogin();
        });

        // **VALIDACI√ìN DE SERVIDOR**
        const validateServer = async () => {
          try {
            console.log("Validando servidor...");
            const response = await fetch(`${API_URL}`, {
              method: "GET",
              headers: { "Content-Type": "application/json" },
            });

            if (response.ok) {
              const data = await response.json();
              console.log("‚úÖ Servidor validado:", data.mensaje);
              return true;
            } else {
              console.log("‚ö†Ô∏è Servidor error:", response.status);
              return false;
            }
          } catch (error) {
            console.log("‚ùå Error conexi√≥n servidor:", error.message);
            return false;
          }
        };

        // Validar servidor al cargar
        validateServer();

        // **SISTEMA DE MENSAJES**
        const showMessage = (message, type = "info") => {
          const messageDiv = document.createElement("div");
          messageDiv.textContent = message;
          messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            max-width: 350px;
            word-wrap: break-word;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            background-color: ${
              type === "success"
                ? "#10B981"
                : type === "error"
                ? "#EF4444"
                : "#3B82F6"
            };
          `;

          document.body.appendChild(messageDiv);

          setTimeout(() => {
            messageDiv.remove();
          }, 5000);
        };

        // **LOGIN CON GOOGLE** üî•
        const handleGoogleLogin = async () => {
          console.log("üîÑ Iniciando Google Login...");

          try {
            // Verificar servidor primero
            const serverOk = await validateServer();
            if (!serverOk) {
              showMessage(
                "‚ö†Ô∏è Servidor no disponible. Verifica que est√© ejecut√°ndose.",
                "error"
              );
              return;
            }

            console.log("üîê Abriendo popup de Google...");

            // Login con Firebase/Google
            const result = await window.signInWithPopup(
              window.firebaseAuth,
              window.googleProvider
            );
            const user = result.user;

            console.log("‚úÖ Autenticaci√≥n Google exitosa:", {
              name: user.displayName,
              email: user.email,
              uid: user.uid,
              verified: user.emailVerified,
            });

            showMessage(`üîê Autenticado como ${user.displayName}`, "success");

            // **ENVIAR AL BACKEND**
            console.log("üì§ Enviando datos al backend...");

            const userData = {
              nombre_usuario: user.displayName,
              correo: user.email,
              firebase_uid: user.uid,
              email_verified: user.emailVerified,
            };

            const response = await fetch(`${API_URL}/login/google`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(userData),
            });

            console.log(
              "üì• Respuesta backend:",
              response.status,
              response.statusText
            );

            if (response.ok) {
              const data = await response.json();
              console.log("‚úÖ Backend confirmado:", data);

              // Guardar usuario
              localStorage.setItem("usuario", JSON.stringify(data.usuario));
              localStorage.setItem("loginTime", new Date().toISOString());
              localStorage.setItem("loginMethod", "google");

              showMessage(
                `üéâ ¬°Bienvenido, ${data.usuario.nombre_usuario}!`,
                "success"
              );

              // Redirigir
              setTimeout(() => {
                console.log("üöÄ Redirigiendo...");
                window.location.href = "index.html";
              }, 2000);
            } else {
              const errorText = await response.text();
              console.error("‚ùå Error backend:", errorText);
              showMessage("‚ùå Error del servidor: " + errorText, "error");
            }
          } catch (error) {
            console.error("‚ùå Error completo Google Login:", error);

            // Errores espec√≠ficos de Firebase
            if (error.code === "auth/popup-closed-by-user") {
              showMessage("‚ö†Ô∏è Ventana cerrada. Intenta de nuevo.", "error");
            } else if (error.code === "auth/popup-blocked") {
              showMessage(
                "‚ö†Ô∏è Popup bloqueado. Permite popups para este sitio.",
                "error"
              );
            } else if (error.code === "auth/cancelled-popup-request") {
              console.log("‚ÑπÔ∏è Popup cancelado (normal)");
            } else if (error.message && error.message.includes("network")) {
              showMessage("‚ùå Error de red. Verifica tu conexi√≥n.", "error");
            } else if (error.message && error.message.includes("API key")) {
              showMessage(
                "‚ùå Error de configuraci√≥n Firebase. Verifica que Identity Toolkit API est√© habilitada.",
                "error"
              );
            } else {
              showMessage("‚ùå Error: " + error.message, "error");
            }
          }
        };

        // **ASIGNAR EVENTOS GOOGLE LOGIN**
        if (elements.googleLoginBtn) {
          console.log("Configurando bot√≥n Google Login");
          elements.googleLoginBtn.addEventListener("click", (e) => {
            e.preventDefault();
            console.log("üñ±Ô∏è Click Google Login");
            handleGoogleLogin();
          });
        }

        if (elements.googleRegisterBtn) {
          console.log("Configurando bot√≥n Google Register");
          elements.googleRegisterBtn.addEventListener("click", (e) => {
            e.preventDefault();
            console.log("üñ±Ô∏è Click Google Register");
            handleGoogleLogin();
          });
        }

        // **LOGIN TRADICIONAL**
        if (elements.loginForm) {
          elements.loginForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            console.log("üîë Login tradicional...");

            const username = elements.loginForm
              .querySelector('input[type="text"]')
              .value.trim();
            const password = elements.loginForm.querySelector(
              'input[type="password"]'
            ).value;

            if (!username || !password) {
              showMessage("‚ö†Ô∏è Ingresa usuario y contrase√±a", "error");
              return;
            }

            try {
              const serverOk = await validateServer();
              if (!serverOk) {
                showMessage("‚ö†Ô∏è Servidor no disponible", "error");
                return;
              }

              const submitBtn = elements.loginForm.querySelector(
                'button[type="submit"]'
              );
              const originalText = submitBtn.textContent;
              submitBtn.textContent = "Iniciando sesi√≥n...";
              submitBtn.disabled = true;

              const response = await fetch(`${API_URL}/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  nombre_usuario: username,
                  contrase√±a: password,
                }),
              });

              if (response.ok) {
                const data = await response.json();
                console.log("‚úÖ Login tradicional exitoso:", data);

                localStorage.setItem("usuario", JSON.stringify(data.usuario));
                localStorage.setItem("loginTime", new Date().toISOString());
                localStorage.setItem("loginMethod", "traditional");

                showMessage(
                  `üéâ ¬°Bienvenido, ${data.usuario.nombre_usuario}!`,
                  "success"
                );

                setTimeout(() => {
                  window.location.href = "innovative.html";
                }, 1500);
              } else {
                const error = await response.text();
                console.error("‚ùå Error login tradicional:", error);

                if (response.status === 401) {
                  showMessage("‚ùå Usuario o contrase√±a incorrectos", "error");
                } else {
                  showMessage("‚ùå Error: " + error, "error");
                }
              }

              submitBtn.textContent = originalText;
              submitBtn.disabled = false;
            } catch (error) {
              console.error("‚ùå Error conexi√≥n login:", error);
              showMessage("‚ùå Error de conexi√≥n", "error");

              const submitBtn = elements.loginForm.querySelector(
                'button[type="submit"]'
              );
              submitBtn.textContent = "Iniciar Sesi√≥n";
              submitBtn.disabled = false;
            }
          });
        }

        // **REGISTRO TRADICIONAL**
        if (elements.registerForm) {
          elements.registerForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            console.log("üìù Registro tradicional...");

            const username = elements.registerForm
              .querySelector('input[type="text"]')
              .value.trim();
            const email = elements.registerForm
              .querySelector('input[type="email"]')
              .value.trim();
            const password = elements.registerForm.querySelector(
              'input[type="password"]'
            ).value;

            // Validaciones
            if (!username || !email || !password) {
              showMessage("‚ö†Ô∏è Completa todos los campos", "error");
              return;
            }

            if (username.length < 3) {
              showMessage("‚ö†Ô∏è Usuario m√≠nimo 3 caracteres", "error");
              return;
            }

            if (password.length < 6) {
              showMessage("‚ö†Ô∏è Contrase√±a m√≠nimo 6 caracteres", "error");
              return;
            }

            if (!email.includes("@")) {
              showMessage("‚ö†Ô∏è Email inv√°lido", "error");
              return;
            }

            try {
              const serverOk = await validateServer();
              if (!serverOk) {
                showMessage("‚ö†Ô∏è Servidor no disponible", "error");
                return;
              }

              const submitBtn = elements.registerForm.querySelector(
                'button[type="submit"]'
              );
              const originalText = submitBtn.textContent;
              submitBtn.textContent = "Creando cuenta...";
              submitBtn.disabled = true;

              const response = await fetch(`${API_URL}/registro`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  nombre_usuario: username,
                  correo: email,
                  contrase√±a: password,
                }),
              });

              if (response.ok) {
                console.log("‚úÖ Registro exitoso");
                showMessage(
                  "üéâ ¬°Cuenta creada! Ahora puedes iniciar sesi√≥n.",
                  "success"
                );

                elements.registerForm.reset();
                setTimeout(() => {
                  showLogin();
                }, 2000);
              } else {
                const error = await response.text();
                console.error("‚ùå Error registro:", error);
                showMessage("‚ùå Error: " + error, "error");
              }

              submitBtn.textContent = originalText;
              submitBtn.disabled = false;
            } catch (error) {
              console.error("‚ùå Error conexi√≥n registro:", error);
              showMessage("‚ùå Error de conexi√≥n", "error");

              const submitBtn = elements.registerForm.querySelector(
                'button[type="submit"]'
              );
              submitBtn.textContent = "Crear Cuenta";
              submitBtn.disabled = false;
            }
          });
        }

        // **ESTADO DE AUTENTICACI√ìN**
        window.onAuthStateChanged(window.firebaseAuth, (user) => {
          if (user) {
            console.log("üë§ Usuario Google autenticado:", user.displayName);
          } else {
            console.log("üë§ No hay usuario Google autenticado");
          }
        });

        console.log("üéâ Sistema completo configurado correctamente");
        console.log("üìä Funcionalidades: Backend ‚úÖ | Google Login ‚úÖ");
      });
    </script>
   <style>
      .divider {
        display: flex;
        align-items: center;
        text-align: center;
        margin: 20px 0;
      }

      .divider::before,
      .divider::after {
        content: "";
        flex: 1;
        height: 1px;
        background: #ddd;
      }

      .divider span {
        padding: 0 15px;
        color: #666;
        font-size: 14px;
      }

      .google-btn {
        width: 100%;
        padding: 12px 20px;
        border: 2px solid #e0e0e0;
        background: white;
        color: #333;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all 0.3s ease;
        margin-bottom: 15px;
      }

      .google-btn:hover {
        border-color: #4285f4;
        box-shadow: 0 2px 8px rgba(66, 133, 244, 0.15);
        background: #f8f9ff;
      }

      .google-btn:active {
        transform: translateY(1px);
      }

      .google-icon {
        flex-shrink: 0;
      }
    </style>
   

</body>
</html>
